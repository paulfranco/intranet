{% extends "base.html" %}
<style>

#post-container {
	background-color: red;
}
</style>

{% block script %}
<script>

function getParameterByName(name, url) {
    if (!url) url = window.location.href;
    name = name.replace(/[\[\]]/g, "\\$&");
    var regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"),
        results = regex.exec(url);
    if (!results) return null;
    if (!results[2]) return '';
    return decodeURIComponent(results[2].replace(/\+/g, " "));
}

$(document).ready(function(){
	//console.log("Ajax is working");
	var query = getParameterByName('q')
	var postList = [];
	var nextPostUrl;


	$(document.body).on("click", ".repostBtn", function(e){
		e.preventDefault()
		console.log("clicked")
		var url = "/api" + $(this).attr("href")

		$.ajax({
			method: "GET",
			url: url,
			success: function(data){
				console.log(data)
				attachPost(data, true, true)
				updateHashLinks()
			},
			error: function(data){
				console.log("error")
				console.log(data)
			}
		})
	})

	function updateHashLinks(){
		$(".media-body").each(function(data){
			var hashTagRegex = /(^|\s)#([\w\d-]+)/g
			var newText = $(this).html().replace(hashTagRegex, "$1<a href='/tags/$2/'>#$2</a>")
			$(this).html(newText)
		})

	}

	function attachPost(postValue, prepend, repost){
		//var postKey = key;
		var dateDisplay = postValue.date_display;
		var postContent = postValue.content;
		var postUser = postValue.user;
		var postFormattedHtml;
		if (repost && postValue.parent){
			// Repost
			var mainPost = postValue.parent 
			postFormattedHtml = "<div class='media'><div class='media-body'><span class='grey-color'> Repost via " + postUser.username + " on " + dateDisplay + "</span><br/>" + mainPost.content + "<br/> via <a href='" + mainPost.user.url + "'>" + mainPost.user.username + "</a> | "+ mainPost.date_display + " | " + "<a href='/post/" + mainPost.id + "'>View</a> | " + "<a class='repostBtn' href='/post/" + postValue.id + "/repost/'>Repost</a>" + "</div></div><hr/>"

		} else {
			// Fresh Post
			postFormattedHtml = "<div class='media'><div class='media-body'>" + postContent + "<br/> via <a href='" + postUser.url+ "'>" + postUser.username + "</a> | " + dateDisplay + " | " + "<a href='/post/" + postValue.id + "'>View</a> | " + "<a class='repostBtn' href='/post/" + postValue.id + "/repost/'>Repost</a>" + "</div></div><hr/>"
		}
		if (prepend==true){
			$("#post-container").prepend(postFormattedHtml)
		} else {
			$("#post-container").append(postFormattedHtml)
		}
	}

	function parsePosts(){
		if (postList == 0){
			$("#post-container").text("No Posts currently found")
		} else {
		// Posts Exists, parse and display them
		$.each(postList, function(key, value){
			var postKey = key;
			if (value.parent){
				attachPost(value, false, true)
			} else {
				attachPost(value)
			}
			
		})
	}
}
	function fetchPosts(url){
		console.log("fetching ...")
		var fetchUrl;
		if (!url){
			fetchUrl = "api/post/"
		} else {
			fetchUrl = url
		}
		$.ajax({
		url: fetchUrl,
		data: {
			"q": query
		},
		method: "GET",
		success: function(data){
			//console.log(data)
			postList = data.results
			if (data.next){
				nextPostUrl = data.next
			} else {
				$("#loadmore").css("display", "none")
			}
			
			parsePosts()
			updateHashLinks()

		},
		error: function(data){
			console.log('error')
			console.log(data)
		}
	})
	}

	fetchPosts()

	$("#loadmore").click(function(event){
		event.preventDefault()
		// Load More Items
		if (nextPostUrl){
			fetchPosts(nextPostUrl)
		}
	})

	var charsStart = 240;
	var charsCurrent = 0; 

	$("#post-form").append("<span id='postCharsLeft'>" + charsStart + "</span>")

	$("#post-form textarea").keyup(function(event){
		var postValue = $(this).val()
		charsCurrent = charsStart - postValue.length
		var spanChars = $("#postCharsLeft")
		spanChars.text(charsCurrent)

		$("#postCharsLeft").text(charsCurrent)

		if (charsCurrent > 0){
			// Remove classes
			spanChars.removeClass("grey-color ")
			spanChars.removeClass("red-color")	
		} else if (charsCurrent == 0){
			// add gray class
			spanChars.removeClass("red-color")	
			spanChars.addClass("grey-color")
		} else if (charsCurrent < 0){
			// add red class
			spanChars.removeClass("grey-color ")
			spanChars.addClass("red-color")
		}
	})


	$("#post-form").submit(function(event){
		event.preventDefault()
		var this_ = $(this)
		var formData = this_.serialize()
		if (charsCurrent >= 0){
			$.ajax({
				url: "/api/post/create/",
				data: formData,
				method: "POST",
				success: function(data){
					this_.find("input[type=text], textarea").val("")
					attachPost(data, true)
					updateHashLinks()
				},
				error: function(data){
					console.log('error')
					console.log(data.statusText)
					console.log(data.status)
				}
			})
		} else {
			console.log("Cannot Send, The Post is too long")
		}
	})

});	

</script>
{% endblock script %}

{% block content %}

	<div class="row">
		<div class="col-sm-3 col-xs-12" style='background-color:white;'>
			<h1>{{ request.user }}</h1> 
		</div>
		<div class='col-sm-9'>
			{% if not request.GET.q %}
			<div class="">
				{% include 'posts/form.html' with form=create_form action_url=create_url btn_title='Post' form_id='post-form' %}
			</div>
			<hr/>
			{% endif %}
			<div id='post-container'>

			</div>
			<a href="#" id="loadmore">Load More Posts</a>
		</div>
		
	</div>
{% endblock content %}

